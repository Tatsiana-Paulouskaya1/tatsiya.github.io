<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>zomby-jump</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        html, body {
            padding: 0;
            margin: 0;
        }

        canvas {
            margin: 0 auto;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, window.innerHeight, Phaser.AUTO, "", { preload: preload, create: create, update: update });
var introText;
var brain;
var playerLastTopPosition;

function preload() {
    game.load.image('back', 'assets/back.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('brain', 'assets/brain.png');
    game.load.image('ground-bottom', 'assets/platform_underground.png');
    game.load.spritesheet('dude', 'assets/zomb.png', 46, 83);
    game.load.spritesheet('spider', 'assets/spider.png', 80, 43);
}
 

function create() {
    
    game.physics.startSystem(Phaser.Physics.ARCADE);  
    game.add.tileSprite(0, 0, 800, 9000, 'back');
    game.world.setBounds(0, 0, 800, 9000);
    game.physics.startSystem(Phaser.Physics.P2JS);

    platforms = game.add.group();
    platforms.enableBody = true;

    ground = platforms.create(0, game.world.height - 64, 'ground-bottom');
    ground.scale.setTo(2, 2);
    ground.body.immovable = true;
    
    for (var i = 6; i < 150; i++) {
        ledge = platforms.create(game.rnd.integerInRange(0, 800), i*59+1, 'ground');
        ledge.body.immovable = true;
        ledge.body.gravity.y = 0;
        ledge.scale.setTo(0.2, 0.4);
    }

    player = game.add.sprite(300, game.world.height - 450, 'dude');
    game.physics.arcade.enable(player);
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 1100;
    player.body.collideWorldBounds = true;
    player.animations.add('left', [0], 10, true);
    player.animations.add('right', [2], 10, true);

    brain = game.add.sprite(200, 50, 'brain');
    brain.enableBody = true;
    game.physics.arcade.enable(brain);
    
    game.camera.follow(player);

    spiders = game.add.group();
    spiders.enableBody = true;
    playerLastTopPosition = player.body.y;

  for (var i = 1; i <= 5; i++) {
        spider = spiders.create(game.rnd.integerInRange(0, 800), game.world.height - i*500, 'spider');
        spider.body.immovable = true;
        spider.body.gravity.y = 0;
        spider.scale.setTo(1.5, 1.5);
        spider.animations.add('run', [0, 1, 2, 3, 4]);
        spider.animations.play('run', 10, true, false);  
    }
 
}

function update() {
    var isCollission= game.physics.arcade.collide(player, platforms, killer, collisionHandler);
    var spiderCollision = game.physics.arcade.collide(player, spiders);

    cursors = game.input.keyboard.createCursorKeys();
    player.body.velocity.x = 0;
  
    if (player.body.touching.down && isCollission){
        player.body.velocity.y = -700;
    }

    if (cursors.left.isDown){
        player.body.velocity.x = -450;
        player.animations.play('left');
    } else if (cursors.right.isDown) {
            player.body.velocity.x = 450;
            player.animations.play('right');
    } else {
        player.frame = 1;
    }

    if(spiderCollision||player.body.bottom === game.world.height) {
        player.kill();
        gameOver();
    }

    if(player.body.y <= 500) {
        gameWin();
    }
   
    spiders.setAll('x', 0, true, true, 5);
    spiders.forEach(runSpider);

    
    if (player.body.velocity.y - player.body.newVelocity.y < 0) {
        playerLastTopPosition = player.body.y; 
    }

    if (playerLastTopPosition - player.body.y < -400) {
        gameOver();
    }
}

function runSpider(spider) {
    spider.body.x +=  1.5;
     if (spider.body.x > game.world.width) {
        spider.body.x = -spider.width;
    }

}

function collisionHandler(player, ledge) {
    if (player.body.center.y < ledge.body.y){          
           return true;
       } else {
           return false;
       }
}

function killer(player, ledge) {  
    if(player.body.bottom <= ledge.body.y) {
        ledge.kill();
    }
}

function gameWin() {
    player.body.gravity.y = 0;
    player.body.velocity.x = 380 - player.body.x;
    player.body.velocity.y = 201 - player.body.y;
    introText = game.add.text(game.world.centerX, game.camera.y + 450, 'Congratulations! \n You won!', { font: "40px Arial", fill: "#ffffff", align: "center" });
    introText.anchor.setTo(0.5, 0.5);
    this.game.camera.follow(null);
    game.physics.arcade.overlap(player, brain, onBrainOverlap);
}

function onBrainOverlap(player, brain) {
    if (player.body.bottom <= brain.body.center.y) {
        player.kill();
    }
}

function gameOver() {
    introText = game.add.text(game.world.centerX, game.camera.y + 450, 'Game Over! \n -click to restart-', { font: "40px Arial", fill: "#ffffff", align: "center" });
    introText.anchor.setTo(0.5, 0.5);
    this.game.camera.follow(null);
    // this.game.state.remove(this.game.state.current);
    game.input.onTap.addOnce(restart,this);
    removeCharacters();
}

function restart() {
    this.game.state.start(this.game.state.current);
}

function removeCharacters() {
    for(let i = 0; i < spiders.children.length; i++) {
        spiders.children[i].kill();
    }

    player.kill();
}

</script>
</body>
</html>